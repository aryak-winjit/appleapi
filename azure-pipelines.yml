# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '2022fff1-5bf4-436c-8791-7ff4661c10ff'
  imageRepository: 'appleapi'
  containerRegistry: 'docuveruspreprodacr.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  acr-registry: 'docuveruspreprodacr.azurecr.io'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    # - task: Docker@2
    #   displayName: Build and push an image to container registry
    #   inputs:
    #     command: buildAndPush
    #     repository: $(imageRepository)
    #     dockerfile: $(dockerfilePath)
    #     containerRegistry: $(dockerRegistryServiceConnection)
    #     tags: |
    #       $(tag)
    - task: DockerInstaller@0
      inputs:
        dockerVersion: '17.09.0-ce'
    - task: CmdLine@2
      displayName: docker login
      inputs:
        script: |
          docker login $(acr-registry) \
          --username  $(username) \
          --password $(password)
    - task: CmdLine@2
      displayName: Build and push image
      inputs:
        script: |
          docker build . -t $(acr-registry)\$(imageRepository):$(tag)
          docker push $(acr-registry)\$(imageRepository):$(tag)
    - task: CmdLine@2
      displayName: Docker Logout
      inputs:
        script: 'docker logout $(acr-registry)' 
...